{{- range $index, $service := .Values.services }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ $.Release.Name }}-{{ $service.name }}-cassandradb-init
  namespace: {{ $.Release.Namespace }}
spec:
  containers:
    - name: cassandra-init
      image: cassandra:4.1.0
      command:
        - sh
        - -c
        - |
          echo "Initializing Cassandra Pod...";
          sleep 60;
          cqlsh {{ $.Release.Name }}-cassandra -u superuser -p $POD_PASSWORD -e "SOURCE '/etc/config/init-schema.cql';"
      env:
        - name: POD_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ $.Release.Name }}-cassandradb-database-secret
              key: pod_password
      volumeMounts:
        - name: script-volume
          mountPath: /etc/config
  volumes:
    - name: script-volume
      configMap:
        name: {{ $.Release.Name }}-{{ $service.name }}-init-script
  restartPolicy: OnFailure
{{- end}}